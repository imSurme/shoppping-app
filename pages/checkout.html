<!DOCTYPE html>
<html class="light" lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <meta name="theme-color" content="#008080"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
    <title>SipariÅŸ Tamamla - Modern Shopping App</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#008080",
                        "primary-dark": "#006666",
                        "background-light": "#FFFFFF",
                        "background-dark": "#101922",
                        "card-background-light": "#F8F9FA",
                        "card-background-dark": "#1a242d",
                        "text-light": "#1F2937",
                        "text-dark": "#F9FAFB",
                        "text-muted-light": "#6B7280",
                        "text-muted-dark": "#9CA3AF",
                        "border-light": "#E5E7EB",
                        "border-dark": "#374151",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.75rem",
                        "lg": "1rem",
                        "xl": "1.25rem",
                        "full": "9999px"
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'soft-dark': '0 2px 15px -3px rgba(0, 0, 0, 0.3), 0 10px 20px -2px rgba(0, 0, 0, 0.2)',
                    }
                },
            },
        }
    </script>
    
    <style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        
        body {
            min-height: 100vh;
            min-height: 100dvh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Touch improvements */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        
        /* Header button animations */
        .header-button {
            transition: all 0.2s ease-in-out;
        }
        
        .header-button:active {
            transform: scale(0.9);
        }
        
        /* Form input focus */
        .form-input:focus {
            border-color: #008080;
            box-shadow: 0 0 0 3px rgba(0, 128, 128, 0.1);
        }
        
        /* Payment method card */
        .payment-method {
            transition: all 0.2s ease-in-out;
        }
        
        .payment-method.selected {
            border-color: #008080;
            background-color: rgba(0, 128, 128, 0.05);
        }
        
        .payment-method:hover {
            border-color: #008080;
        }
        
        /* Step indicator */
        .step-item.active .step-circle {
            background-color: #008080;
            color: white;
        }
        
        .step-item.completed .step-circle {
            background-color: #008080;
            color: white;
        }
        
        .step-item.completed .step-circle span {
            display: none;
        }
        
        .step-item.completed .step-circle::after {
            content: 'âœ“';
            font-size: 14px;
        }
        
        /* Safe area for mobile devices */
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Success animation */
        @keyframes checkmark {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-checkmark {
            animation: checkmark 0.5s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">
    <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
        
        <!-- Header -->
        <header class="sticky top-0 z-20 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md safe-area-top">
            <div class="flex items-center p-4 pb-2 justify-between">
                <button class="header-button flex size-12 shrink-0 items-center justify-center rounded-full hover:bg-card-background-light dark:hover:bg-card-background-dark transition-colors" onclick="goBack()">
                    <span class="material-symbols-outlined text-2xl text-text-light dark:text-text-dark">arrow_back</span>
                </button>
                
                <h1 class="text-text-light dark:text-text-dark text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">SipariÅŸ Tamamla</h1>
                
                <div class="w-12"></div>
            </div>
            
            <!-- Step Indicator -->
            <div class="px-4 pb-4">
                <div class="flex items-center justify-between">
                    <div class="step-item active flex flex-col items-center flex-1" id="step1">
                        <div class="step-circle w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-sm font-bold text-text-muted-light dark:text-text-muted-dark">
                            <span>1</span>
                        </div>
                        <span class="text-xs mt-1 text-text-muted-light dark:text-text-muted-dark">Adres</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-gray-200 dark:bg-gray-700 mx-2"></div>
                    <div class="step-item flex flex-col items-center flex-1" id="step2">
                        <div class="step-circle w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-sm font-bold text-text-muted-light dark:text-text-muted-dark">
                            <span>2</span>
                        </div>
                        <span class="text-xs mt-1 text-text-muted-light dark:text-text-muted-dark">Ã–deme</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-gray-200 dark:bg-gray-700 mx-2"></div>
                    <div class="step-item flex flex-col items-center flex-1" id="step3">
                        <div class="step-circle w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-sm font-bold text-text-muted-light dark:text-text-muted-dark">
                            <span>3</span>
                        </div>
                        <span class="text-xs mt-1 text-text-muted-light dark:text-text-muted-dark">Onay</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow px-4 pb-32">
            
            <!-- Step 1: Delivery Address -->
            <section id="addressSection" class="mb-6">
                <h2 class="text-lg font-bold mb-4 text-text-light dark:text-text-dark">Teslimat Adresi</h2>
                
                <!-- KayÄ±tlÄ± Adresler -->
                <div id="savedAddressesList" class="space-y-3 mb-4">
                    <!-- Profildeki kayÄ±tlÄ± adresler buraya yÃ¼klenecek -->
                </div>
                
                <!-- Manuel adres formu (yeni adres veya kayÄ±tlÄ± yoksa) -->
                <div id="addressFormContainer" class="bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft">
                    <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-3" id="addressFormLabel">Veya yeni adres girin</p>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Ad</label>
                                <input type="text" id="firstName" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="AdÄ±nÄ±z">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Soyad</label>
                                <input type="text" id="lastName" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="SoyadÄ±nÄ±z">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Telefon</label>
                            <input type="tel" id="phone" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="0555 555 55 55">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Adres</label>
                            <textarea id="address" rows="3" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all resize-none" placeholder="Mahalle, sokak, bina no, daire no..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Ä°l</label>
                                <input type="text" id="city" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="Ä°stanbul">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Ä°lÃ§e</label>
                                <input type="text" id="district" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="KadÄ±kÃ¶y">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Step 2: Payment Method -->
            <section id="paymentSection" class="mb-6 hidden">
                <h2 class="text-lg font-bold mb-4 text-text-light dark:text-text-dark">Ã–deme YÃ¶ntemi</h2>
                
                <div class="space-y-3">
                    <!-- KayÄ±tlÄ± Kartlar (profildeki) -->
                    <div id="savedCardsList" class="space-y-3">
                        <!-- Profildeki kayÄ±tlÄ± kartlar buraya yÃ¼klenecek -->
                    </div>
                    
                    <!-- Yeni kart ile Ã¶de (aÃ§Ä±lÄ±r form) -->
                    <div id="newCardOption" class="payment-method cursor-pointer bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft border-2 border-transparent" data-method="card-new" onclick="selectPaymentMethod('card-new')">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary text-2xl">add_card</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-text-light dark:text-text-dark">Yeni kart bilgisi gir</p>
                                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Kart numarasÄ±, son kullanma, CVV</p>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center"></div>
                        </div>
                    </div>
                    
                    <!-- Card Details (shown when "yeni kart" selected) -->
                    <div id="cardDetails" class="bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft hidden">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Kart NumarasÄ±</label>
                                <input type="text" id="cardNumber" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Kart Ãœzerindeki Ä°sim</label>
                                <input type="text" id="cardName" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="AD SOYAD">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Son Kullanma</label>
                                    <input type="text" id="cardExpiry" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="AA/YY" maxlength="5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">CVV</label>
                                    <input type="text" id="cardCvv" class="form-input w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:outline-none transition-all" placeholder="123" maxlength="3">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cash on Delivery -->
                    <div class="payment-method cursor-pointer bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft border-2 border-transparent" data-method="cash" onclick="selectPaymentMethod('cash')">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-green-500 text-2xl">payments</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-text-light dark:text-text-dark">KapÄ±da Ã–deme</p>
                                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Nakit veya kart ile</p>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bank Transfer -->
                    <div class="payment-method cursor-pointer bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft border-2 border-transparent" data-method="transfer" onclick="selectPaymentMethod('transfer')">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-500/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-blue-500 text-2xl">account_balance</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-text-light dark:text-text-dark">Havale / EFT</p>
                                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Banka havalesi ile Ã¶deme</p>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Step 3: Order Summary -->
            <section id="summarySection" class="mb-6 hidden">
                <h2 class="text-lg font-bold mb-4 text-text-light dark:text-text-dark">SipariÅŸ Ã–zeti</h2>
                
                <!-- Order Items -->
                <div class="bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft mb-4">
                    <h3 class="font-semibold mb-3 text-text-light dark:text-text-dark">ÃœrÃ¼nler</h3>
                    <div id="orderItems" class="space-y-3">
                        <!-- Items will be rendered here -->
                    </div>
                </div>
                
                <!-- Delivery Address Summary -->
                <div class="bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-text-light dark:text-text-dark">Teslimat Adresi</h3>
                        <button class="text-primary text-sm font-medium" onclick="goToStep(1)">DÃ¼zenle</button>
                    </div>
                    <p id="summaryAddress" class="text-text-muted-light dark:text-text-muted-dark text-sm"></p>
                </div>
                
                <!-- Payment Method Summary -->
                <div class="bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-text-light dark:text-text-dark">Ã–deme YÃ¶ntemi</h3>
                        <button class="text-primary text-sm font-medium" onclick="goToStep(2)">DÃ¼zenle</button>
                    </div>
                    <p id="summaryPayment" class="text-text-muted-light dark:text-text-muted-dark text-sm"></p>
                </div>
                
                <!-- Price Summary -->
                <div class="bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft">
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-text-muted-light dark:text-text-muted-dark">Ara Toplam</span>
                            <span id="summarySubtotal" class="font-medium text-text-light dark:text-text-dark">â‚º0.00</span>
                        </div>
                        <div id="savingsRow" class="hidden flex justify-between">
                            <span class="text-green-500">KazancÄ±nÄ±z</span>
                            <span id="summarySavings" class="font-medium text-green-500">-â‚º0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-text-muted-light dark:text-text-muted-dark">Kargo</span>
                            <span class="font-medium text-text-light dark:text-text-dark">Ãœcretsiz</span>
                        </div>
                        <div class="border-t border-border-light dark:border-border-dark my-2"></div>
                        <div class="flex justify-between">
                            <span class="font-bold text-text-light dark:text-text-dark">Toplam</span>
                            <span id="summaryTotal" class="font-bold text-primary text-xl">â‚º0.00</span>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Success Section (Hidden initially) -->
            <section id="successSection" class="hidden">
                <div class="flex flex-col items-center justify-center py-12 text-center">
                    <div class="w-24 h-24 rounded-full bg-green-500 flex items-center justify-center mb-6 success-checkmark">
                        <span class="material-symbols-outlined text-white text-5xl" style="font-variation-settings: 'FILL' 1;">check</span>
                    </div>
                    <h2 class="text-2xl font-bold text-text-light dark:text-text-dark mb-2 fade-in-up">SipariÅŸiniz AlÄ±ndÄ±!</h2>
                    <p class="text-text-muted-light dark:text-text-muted-dark mb-2 fade-in-up" style="animation-delay: 0.1s;">SipariÅŸ numaranÄ±z:</p>
                    <p id="orderNumber" class="text-xl font-bold text-primary mb-6 fade-in-up" style="animation-delay: 0.2s;">#123456</p>
                    <p class="text-text-muted-light dark:text-text-muted-dark max-w-xs mb-8 fade-in-up" style="animation-delay: 0.3s;">SipariÅŸiniz en kÄ±sa sÃ¼rede hazÄ±rlanÄ±p kargoya verilecektir. SipariÅŸ durumunuzu profil sayfanÄ±zdan takip edebilirsiniz.</p>
                    <button class="w-full max-w-xs bg-primary text-white font-bold py-4 px-6 rounded-xl fade-in-up" style="animation-delay: 0.4s;" onclick="goToHome()">
                        AlÄ±ÅŸveriÅŸe Devam Et
                    </button>
                </div>
            </section>
            
        </main>

        <!-- Bottom Action Bar -->
        <div id="actionBar" class="fixed bottom-0 left-0 right-0 z-20 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md p-4 border-t border-border-light dark:border-border-dark safe-area-bottom">
            <div class="flex gap-3">
                <button id="backBtn" class="hidden flex-1 py-4 px-6 rounded-xl border-2 border-border-light dark:border-border-dark text-text-light dark:text-text-dark font-bold" onclick="previousStep()">
                    Geri
                </button>
                <button id="nextBtn" class="flex-1 bg-primary text-white font-bold py-4 px-6 rounded-xl" onclick="nextStep()">
                    Devam Et
                </button>
            </div>
        </div>

    </div>

    <!-- Cart Manager -->
    <script src="../js/cart-manager.js"></script>
    
    <!-- JavaScript -->
    <script>
        let currentStep = 1;
        let selectedPayment = 'card'; // 'card', 'card-new', 'cash', 'transfer'
        let selectedPaymentCardId = null; // kayÄ±tlÄ± kart id (selectedPayment === 'card' ise)
        let selectedAddressId = null;   // kayÄ±tlÄ± adres id (null = manuel form kullanÄ±lÄ±yor)
        let savedAddresses = [];
        let savedPaymentMethods = [];
        
        // KayÄ±tlÄ± adresleri yÃ¼kle ve listele
        function loadSavedAddresses() {
            const saved = localStorage.getItem('savedAddresses');
            savedAddresses = saved ? JSON.parse(saved) : [];
            const container = document.getElementById('savedAddressesList');
            container.innerHTML = '';
            
            if (savedAddresses.length === 0) {
                document.getElementById('addressFormLabel').textContent = 'Teslimat adresinizi girin';
                return;
            }
            
            document.getElementById('addressFormLabel').textContent = 'Veya yeni adres girin';
            
            savedAddresses.forEach(addr => {
                const isDefault = addr.isDefault;
                const card = document.createElement('div');
                card.className = `address-option cursor-pointer bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft border-2 ${selectedAddressId === addr.id ? 'border-primary' : 'border-transparent'}`;
                card.dataset.addressId = addr.id;
                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
                                <span class="material-symbols-outlined text-primary text-xl">${addr.title === 'Ev' ? 'home' : addr.title === 'Ä°ÅŸ' ? 'work' : 'location_on'}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <p class="font-semibold text-text-light dark:text-text-dark">${addr.title}</p>
                                    ${isDefault ? '<span class="bg-primary text-white text-xs px-2 py-0.5 rounded-full">VarsayÄ±lan</span>' : ''}
                                </div>
                                <p class="text-sm text-text-muted-light dark:text-text-muted-dark truncate">${addr.fullName} Â· ${addr.phone}</p>
                                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${addr.fullAddress}, ${addr.district}, ${addr.city}</p>
                            </div>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center shrink-0 ${selectedAddressId === addr.id ? 'border-primary' : 'border-gray-300 dark:border-gray-600'}">
                            ${selectedAddressId === addr.id ? '<div class="w-3 h-3 rounded-full bg-primary"></div>' : ''}
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => selectAddress(addr.id));
                container.appendChild(card);
            });
            
            // BaÅŸlangÄ±Ã§ta hiÃ§bir adres seÃ§ili deÄŸil - form boÅŸ kalÄ±r
            // KullanÄ±cÄ± bir adres seÃ§erse o zaman form dolar
        }
        
        function selectAddress(addressId) {
            selectedAddressId = addressId;
            const addr = savedAddresses.find(a => a.id === addressId);
            if (addr) {
                document.getElementById('firstName').value = addr.fullName.split(' ')[0] || '';
                document.getElementById('lastName').value = addr.fullName.split(' ').slice(1).join(' ') || '';
                document.getElementById('phone').value = addr.phone || '';
                document.getElementById('address').value = addr.fullAddress || '';
                document.getElementById('city').value = addr.city || '';
                document.getElementById('district').value = addr.district || '';
            }
            loadSavedAddresses(); // seÃ§ili gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
        }
        
        // KayÄ±tlÄ± kartlarÄ± yÃ¼kle ve listele
        function loadSavedPaymentMethods() {
            const saved = localStorage.getItem('paymentMethods');
            savedPaymentMethods = saved ? JSON.parse(saved) : [];
            const container = document.getElementById('savedCardsList');
            container.innerHTML = '';
            
            if (savedPaymentMethods.length === 0) {
                const newOpt = document.getElementById('newCardOption');
                newOpt.classList.remove('hidden');
                newOpt.classList.add('border-primary', 'selected');
                const dot = newOpt.querySelector('.w-6');
                if (dot) {
                    dot.innerHTML = '<div class="w-3 h-3 rounded-full bg-primary"></div>';
                    dot.classList.add('border-primary');
                    dot.classList.remove('border-gray-300', 'dark:border-gray-600');
                }
                document.getElementById('cardDetails').classList.remove('hidden');
                selectedPayment = 'card-new';
                return;
            }
            
            document.getElementById('newCardOption').classList.remove('hidden');
            
            savedPaymentMethods.forEach(pm => {
                const card = document.createElement('div');
                const isSelected = selectedPayment === 'card' && selectedPaymentCardId === pm.id;
                card.className = `payment-method cursor-pointer bg-card-background-light dark:bg-card-background-dark rounded-xl p-4 shadow-soft border-2 ${isSelected ? 'border-primary selected' : 'border-transparent'}`;
                card.dataset.method = 'card';
                card.dataset.cardId = pm.id;
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-xl">ðŸ’³</div>
                        <div class="flex-1">
                            <p class="font-semibold text-text-light dark:text-text-dark">${pm.cardName}</p>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark">**** **** **** ${typeof pm.cardNumber === 'string' ? pm.cardNumber.slice(-4) : ''}</p>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-primary' : 'border-gray-300 dark:border-gray-600'}">
                            ${isSelected ? '<div class="w-3 h-3 rounded-full bg-primary"></div>' : ''}
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => selectPaymentMethod('card', pm.id));
                container.appendChild(card);
            });
            
            const defaultCard = savedPaymentMethods.find(p => p.isDefault) || savedPaymentMethods[0];
            if (defaultCard && selectedPayment === 'card' && !selectedPaymentCardId) {
                selectPaymentMethod('card', defaultCard.id);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if cart is empty
            if (cartManager.getCartCount() === 0) {
                alert('Sepetiniz boÅŸ! Ã–nce Ã¼rÃ¼n ekleyin.');
                window.location.href = '../index.html';
                return;
            }
            
            loadSavedAddresses();
            loadSavedPaymentMethods();
            updateStepUI();
            
            // Format card number input
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
                let formatted = value.match(/.{1,4}/g)?.join(' ') || '';
                e.target.value = formatted;
            });
            
            // Format expiry date input
            document.getElementById('cardExpiry').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                e.target.value = value;
            });
            
            // Initialize dark mode
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }
        });
        
        // Navigation
        function goBack() {
            if (currentStep > 1) {
                previousStep();
            } else {
                window.location.href = 'shopping-cart.html';
            }
        }
        
        function goToHome() {
            cartManager.clearCart();
            window.location.href = '../index.html';
        }
        
        function goToStep(step) {
            currentStep = step;
            updateStepUI();
        }
        
        function nextStep() {
            if (currentStep === 1) {
                if (!validateAddress()) return;
                currentStep = 2;
            } else if (currentStep === 2) {
                if (!validatePayment()) return;
                currentStep = 3;
                renderOrderSummary();
            } else if (currentStep === 3) {
                completeOrder();
                return;
            }
            updateStepUI();
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
            }
        }
        
        function updateStepUI() {
            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < currentStep) {
                    stepEl.classList.add('completed');
                } else if (i === currentStep) {
                    stepEl.classList.add('active');
                }
            }
            
            // Show/hide sections
            document.getElementById('addressSection').classList.toggle('hidden', currentStep !== 1);
            document.getElementById('paymentSection').classList.toggle('hidden', currentStep !== 2);
            document.getElementById('summarySection').classList.toggle('hidden', currentStep !== 3);
            
            // Update buttons
            document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').textContent = currentStep === 3 ? 'SipariÅŸi Tamamla' : 'Devam Et';
        }
        
        // Validation
        function validateAddress() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const city = document.getElementById('city').value.trim();
            const district = document.getElementById('district').value.trim();
            
            if (!firstName || !lastName || !phone || !address || !city || !district) {
                showError('LÃ¼tfen tÃ¼m alanlarÄ± doldurun.');
                return false;
            }
            
            return true;
        }
        
        function validatePayment() {
            if (selectedPayment === 'card') {
                if (!selectedPaymentCardId) {
                    showError('LÃ¼tfen bir Ã¶deme kartÄ± seÃ§in.');
                    return false;
                }
                return true;
            }
            if (selectedPayment === 'card-new') {
                const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                const cardName = document.getElementById('cardName').value.trim();
                const cardExpiry = document.getElementById('cardExpiry').value.trim();
                const cardCvv = document.getElementById('cardCvv').value.trim();
                
                if (!cardNumber || cardNumber.length < 16) {
                    showError('GeÃ§erli bir kart numarasÄ± girin.');
                    return false;
                }
                if (!cardName) {
                    showError('Kart Ã¼zerindeki ismi girin.');
                    return false;
                }
                if (!cardExpiry || cardExpiry.length < 5) {
                    showError('GeÃ§erli bir son kullanma tarihi girin.');
                    return false;
                }
                if (!cardCvv || cardCvv.length < 3) {
                    showError('GeÃ§erli bir CVV girin.');
                    return false;
                }
            }
            return true;
        }
        
        // Payment method selection (method: 'card', 'card-new', 'cash', 'transfer'; cardId: kayÄ±tlÄ± kart id)
        function selectPaymentMethod(method, cardId) {
            selectedPayment = method;
            selectedPaymentCardId = method === 'card' ? (cardId || selectedPaymentCardId) : null;
            
            // TÃ¼m Ã¶deme seÃ§eneklerindeki radio gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ sÄ±fÄ±rla
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected', 'border-primary');
                el.classList.add('border-transparent');
                const dot = el.querySelector('.w-6');
                if (dot) {
                    dot.innerHTML = '';
                    dot.classList.remove('border-primary');
                    dot.classList.add('border-gray-300', 'dark:border-gray-600');
                }
            });
            
            // KayÄ±tlÄ± kartlardan seÃ§ili olanÄ± iÅŸaretle
            document.querySelectorAll('#savedCardsList .payment-method').forEach(el => {
                if (el.dataset.cardId && parseInt(el.dataset.cardId) === selectedPaymentCardId) {
                    el.classList.add('selected', 'border-primary');
                    el.classList.remove('border-transparent');
                    const dot = el.querySelector('.w-6');
                    if (dot) {
                        dot.innerHTML = '<div class="w-3 h-3 rounded-full bg-primary"></div>';
                        dot.classList.add('border-primary');
                        dot.classList.remove('border-gray-300', 'dark:border-gray-600');
                    }
                }
            });
            
            // "Yeni kart" veya cash/transfer seÃ§eneÄŸini iÅŸaretle
            const selector = method === 'card-new' ? '[data-method="card-new"]' : `[data-method="${method}"]`;
            const selected = document.querySelector(selector);
            if (selected) {
                selected.classList.add('selected', 'border-primary');
                selected.classList.remove('border-transparent');
                const dot = selected.querySelector('.w-6');
                if (dot) {
                    dot.innerHTML = '<div class="w-3 h-3 rounded-full bg-primary"></div>';
                    dot.classList.add('border-primary');
                    dot.classList.remove('border-gray-300', 'dark:border-gray-600');
                }
            }
            
            // Kart detay formunu sadece "yeni kart" seÃ§iliyse gÃ¶ster
            document.getElementById('cardDetails').classList.toggle('hidden', method !== 'card-new');
        }
        
        // Render order summary
        function renderOrderSummary() {
            const cart = cartManager.getCart();
            const orderItems = document.getElementById('orderItems');
            
            orderItems.innerHTML = cart.map(item => `
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-cover bg-center" style="background-image: url('${item.image}');"></div>
                    <div class="flex-1">
                        <p class="font-medium text-text-light dark:text-text-dark text-sm">${item.name}</p>
                        <p class="text-xs text-text-muted-light dark:text-text-muted-dark">${item.size} Ã— ${item.quantity}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-primary">â‚º${(item.price * item.quantity).toFixed(2)}</p>
                        ${item.originalPrice && item.originalPrice > item.price ? `<p class="text-xs text-text-muted-light dark:text-text-muted-dark line-through">â‚º${(item.originalPrice * item.quantity).toFixed(2)}</p>` : ''}
                    </div>
                </div>
            `).join('');
            
            // Address summary
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const district = document.getElementById('district').value;
            
            document.getElementById('summaryAddress').innerHTML = `
                <strong>${firstName} ${lastName}</strong><br>
                ${address}<br>
                ${district}, ${city}<br>
                Tel: ${phone}
            `;
            
            // Payment summary
            let paymentSummaryText = '';
            if (selectedPayment === 'card' && selectedPaymentCardId) {
                const pm = savedPaymentMethods.find(p => p.id === selectedPaymentCardId);
                paymentSummaryText = pm ? `Kart **** ${typeof pm.cardNumber === 'string' ? pm.cardNumber.slice(-4) : ''} (${pm.cardName})` : 'Kredi / Banka KartÄ±';
            } else if (selectedPayment === 'card-new') {
                paymentSummaryText = 'Kredi / Banka KartÄ± (Yeni kart)';
            } else {
                const paymentNames = { 'cash': 'KapÄ±da Ã–deme', 'transfer': 'Havale / EFT' };
                paymentSummaryText = paymentNames[selectedPayment] || '';
            }
            document.getElementById('summaryPayment').textContent = paymentSummaryText;
            
            // Calculate totals with discount
            let subtotalOriginal = 0;
            let totalSavings = 0;
            
            cart.forEach(item => {
                if (item.originalPrice && item.originalPrice > item.price) {
                    subtotalOriginal += item.originalPrice * item.quantity;
                    totalSavings += (item.originalPrice - item.price) * item.quantity;
                } else {
                    subtotalOriginal += item.price * item.quantity;
                }
            });
            
            const total = cartManager.getCartTotal();
            
            document.getElementById('summarySubtotal').textContent = `â‚º${subtotalOriginal.toFixed(2)}`;
            document.getElementById('summaryTotal').textContent = `â‚º${total.toFixed(2)}`;
            
            // Show savings if there are any discounts
            const savingsRow = document.getElementById('savingsRow');
            if (totalSavings > 0) {
                document.getElementById('summarySavings').textContent = `-â‚º${totalSavings.toFixed(2)}`;
                savingsRow.classList.remove('hidden');
            } else {
                savingsRow.classList.add('hidden');
            }
        }
        
        // Complete order
        function completeOrder() {
            // Generate order number
            const orderNumber = '#' + Math.floor(100000 + Math.random() * 900000);
            document.getElementById('orderNumber').textContent = orderNumber;
            
            // Save order to localStorage
            saveOrder(orderNumber);
            
            // Clear cart silently (without showing message)
            localStorage.setItem('shoppingCart', '[]');
            cartManager.updateCartBadge();
            
            // Hide all sections and action bar
            document.getElementById('addressSection').classList.add('hidden');
            document.getElementById('paymentSection').classList.add('hidden');
            document.getElementById('summarySection').classList.add('hidden');
            document.getElementById('actionBar').classList.add('hidden');
            
            // Show success section
            document.getElementById('successSection').classList.remove('hidden');
            
            // Update header
            document.querySelector('header h1').textContent = 'SipariÅŸ TamamlandÄ±';
            document.querySelector('header .px-4').classList.add('hidden'); // Hide step indicator
        }
        
        // Save order to localStorage
        function saveOrder(orderNumber) {
            const cart = cartManager.getCart();
            const total = cartManager.getCartTotal();
            
            const paymentNames = {
                'card': 'Kredi / Banka KartÄ±',
                'cash': 'KapÄ±da Ã–deme',
                'transfer': 'Havale / EFT'
            };
            
            let paymentMethodText = '';
            if (selectedPayment === 'card' && selectedPaymentCardId) {
                const pm = savedPaymentMethods.find(p => p.id === selectedPaymentCardId);
                paymentMethodText = pm ? `Kart **** ${typeof pm.cardNumber === 'string' ? pm.cardNumber.slice(-4) : ''}` : 'Kredi / Banka KartÄ±';
            } else {
                const paymentNames = {
                    'card-new': 'Kredi / Banka KartÄ±',
                    'cash': 'KapÄ±da Ã–deme',
                    'transfer': 'Havale / EFT'
                };
                paymentMethodText = paymentNames[selectedPayment] || 'Kredi / Banka KartÄ±';
            }
            
            const order = {
                orderNumber: orderNumber,
                date: new Date().toISOString(),
                status: 'processing',
                items: cart,
                total: total,
                address: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    district: document.getElementById('district').value
                },
                paymentMethod: paymentMethodText
            };
            
            // Get existing orders or create empty array
            let orders = JSON.parse(localStorage.getItem('orders') || '[]');
            
            // Add new order at the beginning
            orders.unshift(order);
            
            // Save to localStorage
            localStorage.setItem('orders', JSON.stringify(orders));
        }
        
        // Messages
        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-primary text-white px-6 py-3 rounded-lg shadow-lg';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
